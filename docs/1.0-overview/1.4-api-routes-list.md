# API Routes

This document provides a comprehensive overview of all API routes available in the PageSpace application, categorized by domain. For detailed request/response schemas, status codes, and specific handler information, please refer to the individual markdown files within the `docs/2.0-architecture/2.4-api/` directory.

## Authentication Routes

### POST /api/auth/login
**Purpose:** Authenticates a user with email/password. Includes rate limiting, session management, and issues secure access/refresh tokens as HttpOnly cookies.

### POST /api/auth/logout
**Purpose:** Logs out a user by invalidating their refresh token in the database and clearing authentication cookies.

### POST /api/auth/signup
**Purpose:** Registers a new user with email/password validation, creates their personal drive, default AI settings, and establishes their initial session.

### GET /api/auth/me
**Purpose:** Retrieves the currently authenticated user's details from their JWT access token.

### POST /api/auth/refresh
**Purpose:** Refreshes access and refresh tokens using a one-time refresh token. Implements token rotation for enhanced security with rate limiting.

### GET /api/auth/csrf
**Purpose:** Generates a CSRF token for the current authenticated session. Used for CSRF protection in forms and state-changing requests.

### GET, POST /api/auth/mcp-tokens
**Purpose:** Manages MCP (Model Context Protocol) authentication tokens. GET lists active tokens, POST creates new tokens.

### DELETE /api/auth/mcp-tokens/[tokenId]
**Purpose:** Revokes a specific MCP token by setting its revokedAt timestamp.

### GET, POST /api/auth/google/signin
**Purpose:** Initiates Google OAuth authentication. POST generates OAuth URL with optional return URL, GET redirects to Google OAuth.

### GET /api/auth/google/callback
**Purpose:** Handles Google OAuth callback, processes authorization code, creates/updates users, and handles profile sync.

## AI Routes

### GET, POST, PATCH /api/ai/chat
**Purpose:** Main AI chat endpoint with multi-provider support (OpenRouter, Google AI, OpenAI, Anthropic, xAI). POST streams AI responses with tool support, GET checks provider configuration, PATCH updates page-specific AI settings. **PATCH requires:** Edit permission for the target page and validates provider/model combinations with subscription requirements.

### GET /api/ai/chat/messages
**Purpose:** Loads chat messages for a specific page in chronological order with tool calls/results. **Requires:** View permission for the specified page.

### GET, POST, PATCH, DELETE /api/ai/settings
**Purpose:** Manages AI provider settings and API keys. GET checks status, POST saves API keys, PATCH updates provider/model selection, DELETE removes API keys.

### GET /api/ai/ollama/models
**Purpose:** Lists available Ollama models for local AI processing.

### GET /api/ai/tasks/[taskId]/status
**Purpose:** Get the status of a specific AI task.

### GET /api/ai/tasks/by-message/[messageId]
**Purpose:** Get task information associated with a specific message.

## Pages Routes

### POST /api/pages
**Purpose:** Creates new pages (documents, folders, AI chats, channels, canvas dashboards, files) with automatic positioning and AI provider inheritance. Uses centralized `validatePageCreation()` for type-specific validation and `getDefaultContent()` for initial content. Canvas pages support custom HTML/CSS dashboards with functional navigation.

### GET, PATCH, DELETE /api/pages/[pageId]
**Purpose:** CRUD operations for individual pages. GET fetches page with children/messages, PATCH updates title/content with mention synchronization, DELETE moves to trash.

### GET /api/pages/[pageId]/breadcrumbs
**Purpose:** Returns hierarchical breadcrumb navigation path from drive root to current page.

### GET /api/pages/[pageId]/children
**Purpose:** Lists direct child pages with basic metadata.

### GET, POST, PATCH, DELETE /api/pages/[pageId]/permissions
**Purpose:** Manages page-level permissions with RBAC system for view/edit/delete permissions for users.

### GET /api/pages/[pageId]/permissions/check
**Purpose:** Checks specific permissions for current user, returns boolean permission status.

### POST /api/pages/[pageId]/restore
**Purpose:** Restores trashed pages from trash back to original location.

### POST /api/pages/reorder
**Purpose:** Updates page position values for drag-and-drop reordering within parent containers.

### GET, PATCH /api/pages/[pageId]/agent-config
**Purpose:** AI agent configuration management. GET retrieves current agent settings (systemPrompt, enabledTools, availableTools), PATCH updates configuration with validation against available PageSpace tools.

### GET /api/pages/[pageId]/processing-status
**Purpose:** Get file processing status for FILE type pages.

### POST /api/pages/[pageId]/reprocess
**Purpose:** Requeue a file for processing.

### POST /api/pages/bulk/create-structure
**Purpose:** Create multiple pages in a folder structure atomically.

### POST /api/pages/bulk/delete
**Purpose:** Delete multiple pages in a single operation.

### POST /api/pages/bulk/move
**Purpose:** Move multiple pages to a new parent or drive.

### POST /api/pages/bulk/rename
**Purpose:** Rename multiple pages using pattern matching.

### POST /api/pages/bulk/update-content
**Purpose:** Update content in multiple pages simultaneously.

## Drive Routes

### GET /api/drives
**Purpose:** Fetches all drives accessible by the authenticated user (owned and shared).

### POST /api/drives
**Purpose:** Creates a new drive for the authenticated user.

### GET, PATCH /api/drives/[driveId]
**Purpose:** Individual drive operations. GET retrieves drive details with ownership/membership status, PATCH updates drive settings (name, AI preferences).

### GET /api/drives/[driveId]/pages
**Purpose:** Fetches all pages within a specific drive, structured as a hierarchical tree.

### GET /api/drives/[driveId]/trash
**Purpose:** Fetches all trashed pages within a specific drive with restoration options.

### GET, POST /api/drives/[driveId]/members
**Purpose:** Manages drive membership. GET lists members with roles, POST adds new members.

### DELETE /api/drives/[driveId]/members/[userId]
**Purpose:** Removes a member from drive (requires ownership verification).

### POST /api/drives/[driveId]/members/invite
**Purpose:** Sends email-based invitations to join a drive.

### GET /api/drives/[driveId]/permissions-tree
**Purpose:** Returns complete permissions hierarchy for drive admin interfaces.

### GET, POST /api/drives/[driveId]/agents
**Purpose:** Manage AI agents within a drive. GET lists agents, POST creates new agent.

### GET /api/drives/[driveId]/search/regex
**Purpose:** Search page content using regex patterns within a drive.

### GET /api/drives/[driveId]/search/glob
**Purpose:** Search pages using glob patterns for titles and paths within a drive.

### POST /api/drives/[driveId]/restore
**Purpose:** Restore a trashed drive back to active state.

## User & Account Routes

### GET, PATCH /api/account
**Purpose:** User account management. GET retrieves current user profile, PATCH updates name and email with validation.

### PATCH /api/account/password
**Purpose:** Changes user password with current password verification and bcrypt hashing.

### POST /api/account/avatar
**Purpose:** Upload and update user avatar image.

### GET /api/users/search
**Purpose:** Searches users for mentions and collaboration by username, display name, or email with privacy controls.

### GET /api/users/find
**Purpose:** Finds users by specific criteria for administrative functions.

## AI Conversations Routes

### GET, POST /api/ai_conversations
**Purpose:** AI conversation management. GET lists user's AI conversations, POST creates new AI conversation contexts.

### GET, PATCH, DELETE /api/ai_conversations/[id]
**Purpose:** Individual AI conversation operations for metadata and lifecycle management.

### GET, POST /api/ai_conversations/[id]/messages
**Purpose:** Manages AI conversation message history and real-time chat functionality.

### GET /api/ai_conversations/global
**Purpose:** Accesses default global AI conversation context for users.

## Notifications Routes

### GET /api/notifications
**Purpose:** Lists user notifications with support for count-only mode and pagination.

### GET, PATCH, DELETE /api/notifications/[id]
**Purpose:** Individual notification operations for metadata and status management.

### POST /api/notifications/[id]/read
**Purpose:** Marks a specific notification as read.

### POST /api/notifications/read-all
**Purpose:** Marks all user notifications as read in bulk.

## Channel Routes

### GET, POST /api/channels/[pageId]/messages
**Purpose:** Channel message management for real-time messaging in channel-type pages.

## Mentions Routes

### GET /api/mentions/search
**Purpose:** Searches for mentionable entities (@mentions) with cross-drive capability and permission-aware results for pages and users.

## MCP Routes

### POST /api/mcp/documents
**Purpose:** MCP document line operations (read, replace, insert, delete) with formatting, requires MCP token authentication.

### GET /api/mcp/drives
**Purpose:** Lists drives accessible via MCP for client drive discovery.

### GET /api/mcp/detect-paths
**Purpose:** Detects and resolves MCP paths for integrations.

## Admin Routes

### GET /api/admin/users
**Purpose:** Administrative user management with complete statistics including drives, pages, messages, and AI settings.

### GET /api/admin/schema
**Purpose:** Provides database schema information for administrative tools.

## Monitoring Routes

### GET /api/monitoring/[metric]
**Purpose:** System monitoring and analytics supporting system-health, api-metrics, user-activity, ai-usage, error-logs, and performance metrics with time range filtering.

## File Upload Routes

### POST /api/upload
**Purpose:** Handles file uploads for pages. Validates authentication, file size (max 100MB), forwards to processor service for storage and processing, creates database entry with appropriate processing status (visual/pending/completed).

### GET /api/files/[id]/view
**Purpose:** Serves uploaded files to authenticated users. Verifies permissions, fetches from processor service, streams to client with appropriate headers and content type.

## Agent Management Routes

### GET, POST /api/agents/create
**Purpose:** Create new AI agents with custom configuration and tools.

### GET, PATCH /api/agents/[agentId]/config
**Purpose:** Manage individual agent configuration, system prompts, and enabled tools.

### POST /api/agents/consult
**Purpose:** Consult an AI agent for specialized knowledge (agent-to-agent communication).

### GET /api/agents/multi-drive
**Purpose:** List all agents across multiple drives with filtering options.

## Search & Discovery Routes

### GET /api/search
**Purpose:** Global search across all accessible pages and content.

### GET /api/search/multi-drive
**Purpose:** Search across multiple drives simultaneously with advanced filtering.

### POST /api/permissions/batch
**Purpose:** Update permissions for multiple pages or users in a single operation.

## Storage & Subscription Routes

### GET /api/storage/check
**Purpose:** Check storage quota and usage for the current user.

### GET /api/storage/info
**Purpose:** Get detailed storage information and limits.

### GET /api/subscriptions/status
**Purpose:** Get current subscription status and plan details.

### GET /api/subscriptions/usage
**Purpose:** Get usage metrics for current billing period.

### POST /api/stripe/portal
**Purpose:** Create Stripe customer portal session for subscription management.

### POST /api/stripe/webhook
**Purpose:** Handle Stripe webhook events for subscription updates.

## Connections Routes

### GET, POST /api/connections
**Purpose:** Manage user connections and relationships.

### GET /api/connections/search
**Purpose:** Search for users to connect with.

### DELETE /api/connections/[connectionId]
**Purpose:** Remove a user connection.

## Contact & Support Routes

### POST /api/contact
**Purpose:** Submit contact form or support request.

### POST /api/admin/contact
**Purpose:** Administrative contact management.

## Utility Routes

### POST, PUT /api/track
**Purpose:** Client-side event tracking for fire-and-forget analytics including page views, feature usage, errors, and timing data.

### DELETE /api/trash/[pageId]
**Purpose:** Permanently deletes pages from trash (final deletion).

### DELETE /api/trash/drives/[driveId]
**Purpose:** Permanently delete a trashed drive.

### GET /api/compiled-css
**Purpose:** Serves compiled CSS for dynamic styling.

### GET /api/debug/chat-messages
**Purpose:** Debug endpoint for chat message structure analysis (development/debugging tool).

### GET /api/avatar/[userId]/[filename]
**Purpose:** Serve user avatar images.

### GET, POST /api/files/[id]/convert-to-document
**Purpose:** Convert a FILE page to a DOCUMENT page with extracted content.

### GET /api/files/[id]/download
**Purpose:** Download the original uploaded file.

### POST /api/internal/monitoring/ingest
**Purpose:** Internal monitoring data ingestion endpoint.

## Key Architectural Features

- **Dual Authentication:** Supports both JWT cookies and MCP Bearer tokens
- **Rate Limiting:** Implemented on sensitive endpoints (login, refresh, token operations)
- **RBAC Permissions:** Comprehensive user and page-level permission system
- **Multi-Provider AI:** Supports Ollama (local), OpenRouter, Google AI, OpenAI, Anthropic, xAI with streaming
- **Real-time Updates:** Socket.IO integration for live collaboration
- **Database-First:** Immediate persistence for reliability and consistency
- **Content Management:** Rich content with mention system and HTML sanitization
- **Comprehensive Monitoring:** Tracking and analytics throughout the system