# PageSpace Functions List

This document provides a comprehensive list of all functions across the PageSpace codebase, organized by category and location. Last updated: 2025-08-21.

## Database Functions

### Migration Functions
**Location:** `packages/db/src/migrate.ts`

#### main(): Promise<void>
**Purpose:** Executes database migrations using Drizzle ORM. It loads environment variables, connects to the database, runs pending migrations from the 'drizzle' folder, and then exits the process.
**Dependencies:** [`migrate`](drizzle-orm/node-postgres/migrator:migrate()), [`db`](packages/db:db), [`path`](path), [`config`](dotenv:config()).
**Last Updated:** 2025-08-21

### Admin Utilities
**Location:** `packages/db/src/promote-admin.ts`

#### promoteToAdmin(): Promise<void>
**Purpose:** Promotes a user to admin role by updating their role in the database.
**Dependencies:** [`db`](packages/db:db), [`users`](packages/db/schema:users), [`eq`](drizzle-orm:eq).
**Last Updated:** 2025-08-21

### Permission Migration
**Location:** `packages/db/src/migrate-permissions.ts`

#### migratePermissions(): Promise<void>
**Purpose:** Migrates old permission system to new RBAC structure, updating page permissions and drive member roles.
**Dependencies:** [`db`](packages/db:db), [`sql`](drizzle-orm:sql), [`permissions`](packages/db/schema:permissions), [`pagePermissions`](packages/db/schema:pagePermissions), [`driveMembers`](packages/db/schema:driveMembers).
**Last Updated:** 2025-08-21

### Database Client
**Location:** `packages/db/src/index.ts`

#### db (Export)
**Purpose:** Main Drizzle database client providing connection and query interface for PostgreSQL.
**Dependencies:** [`drizzle-orm`](drizzle-orm), [`pg`](pg), [`schema`](packages/db/schema).
**Last Updated:** 2025-08-21

## Authentication & Security Functions

### JWT & Token Management
**Location:** `packages/lib/src/auth-utils.ts`

#### decodeToken(token: string): Promise<UserPayload | null>
**Purpose:** Decodes and verifies a JWT token with issuer/audience validation, returning the payload if valid.
**Dependencies:** [`jose`](jose).
**Last Updated:** 2025-08-21

#### generateAccessToken(userId: string, tokenVersion: number, role?: string): Promise<string>
**Purpose:** Generates a new access token for a user with a 15-minute expiration using HS256 algorithm.
**Dependencies:** [`jose`](jose).
**Last Updated:** 2025-08-21

#### generateRefreshToken(userId: string, tokenVersion: number, role?: string): Promise<string>
**Purpose:** Generates a new refresh token for a user with a 7-day expiration using HS256 algorithm.
**Dependencies:** [`jose`](jose).
**Last Updated:** 2025-08-21

#### isAdmin(userPayload: UserPayload): boolean
**Purpose:** Checks if the user payload indicates admin privileges.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### requireAdminPayload(userPayload: UserPayload | null): UserPayload
**Purpose:** Validates that user payload has admin privileges, throws error if not.
**Dependencies:** None.
**Last Updated:** 2025-08-21

### CSRF Protection
**Location:** `packages/lib/src/csrf-utils.ts`

#### generateCSRFToken(sessionId: string): string
**Purpose:** Generates a cryptographically secure CSRF token with timestamp and HMAC signature for the given session ID.
**Dependencies:** [`randomBytes`](crypto:randomBytes()), [`createHmac`](crypto:createHmac()).
**Last Updated:** 2025-08-21

#### validateCSRFToken(token: string, sessionId: string, maxAge?: number): boolean
**Purpose:** Validates a CSRF token against the session ID, checking signature and expiration (default 1 hour).
**Dependencies:** [`createHmac`](crypto:createHmac()), [`timingSafeEqual`](crypto:timingSafeEqual()).
**Last Updated:** 2025-08-21

#### getSessionIdFromJWT(payload: UserPayload): string
**Purpose:** Extracts a deterministic session ID from JWT payload for CSRF validation.
**Dependencies:** [`createHmac`](crypto:createHmac()).
**Last Updated:** 2025-08-21

### Encryption Utilities
**Location:** `packages/lib/src/encryption-utils.ts`

#### encrypt(text: string): string
**Purpose:** Encrypts text using AES-256-GCM algorithm with initialization vector.
**Dependencies:** [`crypto`](crypto).
**Last Updated:** 2025-08-21

#### decrypt(encryptedText: string): string
**Purpose:** Decrypts text encrypted with AES-256-GCM algorithm.
**Dependencies:** [`crypto`](crypto).
**Last Updated:** 2025-08-21

### Rate Limiting
**Location:** `packages/lib/src/rate-limit-utils.ts`

#### checkRateLimit(identifier: string, config: RateLimitConfig): Promise<RateLimitResult>
**Purpose:** Checks if an identifier is within rate limits using sliding window algorithm.
**Dependencies:** Memory-based rate limiting.
**Last Updated:** 2025-08-21

#### resetRateLimit(identifier: string): void
**Purpose:** Resets rate limit counter for given identifier.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### getRateLimitStatus(identifier: string, config: RateLimitConfig): RateLimitStatus
**Purpose:** Gets current rate limit status for identifier without incrementing counter.
**Dependencies:** None.
**Last Updated:** 2025-08-21

## API Route Handlers

### Authentication Routes
**Location:** `apps/web/src/app/api/auth/`

#### POST /api/auth/login
**Purpose:** Authenticates user with email/password, returns access and refresh tokens.
**Dependencies:** [`bcryptjs`](bcryptjs), [`db`](packages/db), [`auth-utils`](packages/lib/auth-utils).
**Last Updated:** 2025-08-21

#### POST /api/auth/signup
**Purpose:** Registers new user account with email/password validation.
**Dependencies:** [`bcryptjs`](bcryptjs), [`db`](packages/db), [`auth-utils`](packages/lib/auth-utils).
**Last Updated:** 2025-08-21

#### POST /api/auth/logout
**Purpose:** Invalidates user session and refresh token.
**Dependencies:** [`db`](packages/db), [`auth-utils`](packages/lib/auth-utils).
**Last Updated:** 2025-08-21

#### GET /api/auth/me
**Purpose:** Returns current authenticated user information.
**Dependencies:** [`auth-utils`](packages/lib/auth-utils), [`db`](packages/db).
**Last Updated:** 2025-08-21

#### POST /api/auth/refresh
**Purpose:** Generates new access token using valid refresh token.
**Dependencies:** [`auth-utils`](packages/lib/auth-utils), [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/auth/csrf
**Purpose:** Generates and returns CSRF token for session protection.
**Dependencies:** [`csrf-utils`](packages/lib/csrf-utils).
**Last Updated:** 2025-08-21

### Google OAuth Routes
**Location:** `apps/web/src/app/api/auth/google/`

#### POST /api/auth/google/signin
**Purpose:** Initiates Google OAuth flow and handles authentication.
**Dependencies:** [`google-auth-library`](google-auth-library), [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/auth/google/callback
**Purpose:** Handles Google OAuth callback and completes authentication.
**Dependencies:** [`google-auth-library`](google-auth-library), [`db`](packages/db).
**Last Updated:** 2025-08-21

### MCP Token Routes
**Location:** `apps/web/src/app/api/auth/mcp-tokens/`

#### POST /api/auth/mcp-tokens
**Purpose:** Creates new MCP (Model Context Protocol) token for API access.
**Dependencies:** [`db`](packages/db), [`crypto`](crypto).
**Last Updated:** 2025-08-21

#### GET /api/auth/mcp-tokens
**Purpose:** Lists all MCP tokens for authenticated user.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### DELETE /api/auth/mcp-tokens/[tokenId]
**Purpose:** Deletes specific MCP token by ID.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

### Pages Routes
**Location:** `apps/web/src/app/api/pages/`

#### GET /api/pages/[pageId]
**Purpose:** Retrieves page data with permission validation.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### PATCH /api/pages/[pageId]
**Purpose:** Updates page content, title, or metadata with permission check.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### DELETE /api/pages/[pageId]
**Purpose:** Moves page to trash or permanently deletes it.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### POST /api/pages
**Purpose:** Creates new page in specified drive with permission validation.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### PATCH /api/pages/reorder
**Purpose:** Updates page order within drive hierarchy.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### POST /api/pages/[pageId]/restore
**Purpose:** Restores page from trash to active state.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

### Page Permission Routes
**Location:** `apps/web/src/app/api/pages/[pageId]/permissions/`

#### GET /api/pages/[pageId]/permissions
**Purpose:** Retrieves all permissions for a specific page.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### POST /api/pages/[pageId]/permissions
**Purpose:** Grants permissions to user for specific page.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### DELETE /api/pages/[pageId]/permissions
**Purpose:** Revokes permissions from user for specific page.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### GET /api/pages/[pageId]/permissions/check
**Purpose:** Checks specific permission level for current user on page.
**Dependencies:** [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

### Page Agent Configuration Routes
**Location:** `apps/web/src/app/api/pages/[pageId]/agent-config/`

#### GET /api/pages/[pageId]/agent-config
**Purpose:** Retrieves AI agent configuration for a specific page, including system prompt, enabled tools, and available tool list.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions), [`ai-tools`](apps/web/lib/ai/ai-tools).
**Last Updated:** 2025-09-10

#### PATCH /api/pages/[pageId]/agent-config
**Purpose:** Updates AI agent configuration (systemPrompt, enabledTools) with validation against available PageSpace tools.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions), [`ai-tools`](apps/web/lib/ai/ai-tools).
**Last Updated:** 2025-09-10

### Drives Routes
**Location:** `apps/web/src/app/api/drives/`

#### GET /api/drives
**Purpose:** Lists all drives accessible to authenticated user.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### POST /api/drives
**Purpose:** Creates new drive with user as owner.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/drives/[driveId]
**Purpose:** Retrieves drive details with permission validation.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### PATCH /api/drives/[driveId]
**Purpose:** Updates drive name, description, or settings.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### GET /api/drives/[driveId]/pages
**Purpose:** Lists all pages in drive with hierarchical structure.
**Dependencies:** [`db`](packages/db), [`tree-utils`](packages/lib/tree-utils).
**Last Updated:** 2025-08-21

#### POST /api/drives/[driveId]/pages
**Purpose:** Creates new page within specific drive.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

### Drive Members Routes
**Location:** `apps/web/src/app/api/drives/[driveId]/members/`

#### GET /api/drives/[driveId]/members
**Purpose:** Lists all members of a drive with their roles.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### POST /api/drives/[driveId]/members
**Purpose:** Adds new member to drive with specified role.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### GET /api/drives/[driveId]/members/[userId]
**Purpose:** Retrieves specific member details and permissions.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### PATCH /api/drives/[driveId]/members/[userId]
**Purpose:** Updates member role or permissions within drive.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### POST /api/drives/[driveId]/members/invite
**Purpose:** Sends invitation to user to join drive.
**Dependencies:** [`db`](packages/db), [`notifications`](packages/lib/notifications).
**Last Updated:** 2025-08-21

### AI Routes
**Location:** `apps/web/src/app/api/ai/`

#### POST /api/ai/chat
**Purpose:** Processes AI chat messages using configured AI provider.
**Dependencies:** [`ai`](ai), [`ai-providers`](packages/lib/ai), [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/ai/chat
**Purpose:** Retrieves AI chat conversations for user.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### PATCH /api/ai/chat
**Purpose:** Updates AI chat conversation metadata.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/ai/chat/messages
**Purpose:** Retrieves messages from AI chat conversation.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/ai/settings
**Purpose:** Retrieves AI configuration and provider settings.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### POST /api/ai/settings
**Purpose:** Creates new AI provider configuration.
**Dependencies:** [`db`](packages/db), [`encryption-utils`](packages/lib/encryption-utils).
**Last Updated:** 2025-08-21

#### PATCH /api/ai/settings
**Purpose:** Updates AI provider configuration and settings.
**Dependencies:** [`db`](packages/db), [`encryption-utils`](packages/lib/encryption-utils).
**Last Updated:** 2025-08-21

#### DELETE /api/ai/settings
**Purpose:** Removes AI provider configuration.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

### Conversations Routes
**Location:** `apps/web/src/app/api/conversations/`

#### GET /api/conversations
**Purpose:** Lists all conversations for authenticated user.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### POST /api/conversations
**Purpose:** Creates new conversation thread.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/conversations/[id]
**Purpose:** Retrieves specific conversation with messages.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### PATCH /api/conversations/[id]
**Purpose:** Updates conversation title or metadata.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### DELETE /api/conversations/[id]
**Purpose:** Deletes conversation and all associated messages.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/conversations/[id]/messages
**Purpose:** Retrieves paginated messages from conversation.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### POST /api/conversations/[id]/messages
**Purpose:** Adds new message to conversation thread.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

### Notifications Routes
**Location:** `apps/web/src/app/api/notifications/`

#### GET /api/notifications
**Purpose:** Retrieves user notifications with pagination.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### DELETE /api/notifications/[id]
**Purpose:** Deletes specific notification.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### PATCH /api/notifications/[id]/read
**Purpose:** Marks notification as read.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### PATCH /api/notifications/read-all
**Purpose:** Marks all user notifications as read.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

### Channel Routes
**Location:** `apps/web/src/app/api/channels/`

#### GET /api/channels/[pageId]/messages
**Purpose:** Retrieves channel messages for specific page.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### POST /api/channels/[pageId]/messages
**Purpose:** Posts new message to page channel.
**Dependencies:** [`db`](packages/db), [`socket-utils`](packages/lib/socket-utils).
**Last Updated:** 2025-08-21

### Mentions Routes
**Location:** `apps/web/src/app/api/mentions/`

#### GET /api/mentions/search
**Purpose:** Searches for mentionable entities (users, pages, AI agents).
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

### User Routes
**Location:** `apps/web/src/app/api/users/`

#### GET /api/users/find
**Purpose:** Finds users by email or username for collaboration.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/users/search
**Purpose:** Searches users with pagination and filters.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### GET /api/users/profile
**Purpose:** Retrieves current user profile information.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### POST /api/users/profile
**Purpose:** Updates user profile information.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

### Account Routes
**Location:** `apps/web/src/app/api/account/`

#### GET /api/account
**Purpose:** Retrieves user account settings and preferences.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### PATCH /api/account
**Purpose:** Updates user account settings.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### POST /api/account/password
**Purpose:** Changes user password with current password verification.
**Dependencies:** [`bcryptjs`](bcryptjs), [`db`](packages/db).
**Last Updated:** 2025-08-21

### Monitoring Routes
**Location:** `apps/web/src/app/api/monitoring/`

#### GET /api/monitoring/[metric]
**Purpose:** Retrieves application performance and usage metrics.
**Dependencies:** [`monitoring-utils`](packages/lib/monitoring).
**Last Updated:** 2025-08-21

### MCP Routes
**Location:** `apps/web/src/app/api/mcp/`

#### POST /api/mcp/documents
**Purpose:** Handles MCP document operations and queries.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

#### GET /api/mcp/detect-paths
**Purpose:** Detects available MCP paths for integration.
**Dependencies:** [`mcp-utils`](packages/lib/mcp).
**Last Updated:** 2025-08-21

#### POST /api/mcp/drives
**Purpose:** Creates or updates drives via MCP protocol.
**Dependencies:** [`db`](packages/db), [`mcp-utils`](packages/lib/mcp).
**Last Updated:** 2025-08-21

#### GET /api/mcp/drives
**Purpose:** Retrieves drives accessible via MCP protocol.
**Dependencies:** [`db`](packages/db), [`mcp-utils`](packages/lib/mcp).
**Last Updated:** 2025-08-21

### Admin Routes
**Location:** `apps/web/src/app/api/admin/`

#### GET /api/admin/users
**Purpose:** Lists all users for admin management (admin only).
**Dependencies:** [`db`](packages/db), [`auth-utils`](packages/lib/auth-utils).
**Last Updated:** 2025-08-21

#### GET /api/admin/schema
**Purpose:** Retrieves database schema information (admin only).
**Dependencies:** [`db`](packages/db), [`auth-utils`](packages/lib/auth-utils).
**Last Updated:** 2025-08-21

### Tracking Routes
**Location:** `apps/web/src/app/api/track/`

#### POST /api/track
**Purpose:** Tracks user analytics and usage events.
**Dependencies:** [`tracking-utils`](packages/lib/tracking).
**Last Updated:** 2025-08-21

#### PUT /api/track
**Purpose:** Updates tracking data for analytics.
**Dependencies:** [`tracking-utils`](packages/lib/tracking).
**Last Updated:** 2025-08-21

### Trash Routes
**Location:** `apps/web/src/app/api/trash/`

#### DELETE /api/trash/[pageId]
**Purpose:** Permanently deletes page from trash.
**Dependencies:** [`db`](packages/db), [`permissions`](packages/lib/permissions).
**Last Updated:** 2025-08-21

## AI & LLM Functions

### AI Configuration
**Location:** `apps/web/src/lib/ai/`

#### getBackendProvider(uiProvider: string): string
**Purpose:** Maps UI provider names to backend AI provider implementations.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### getDefaultModel(provider: string): string
**Purpose:** Returns default model for given AI provider.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### isValidModel(provider: string, model: string): boolean
**Purpose:** Validates if model is supported by provider.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### getModelDisplayName(provider: string, model: string): string
**Purpose:** Returns human-readable display name for AI model.
**Dependencies:** None.
**Last Updated:** 2025-08-21

### AI Message Processing
**Location:** `apps/web/src/lib/ai/`

#### extractMessageContent(message: UIMessage): string
**Purpose:** Extracts text content from AI message object.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### extractToolCalls(message: UIMessage): ToolCall[]
**Purpose:** Extracts tool calls from AI message.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### extractToolResults(message: UIMessage): ToolResult[]
**Purpose:** Extracts tool execution results from AI message.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### convertDbMessageToUIMessage(dbMessage: any): UIMessage
**Purpose:** Converts database message format to UI message format.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### sanitizeContent(content: string): string
**Purpose:** Sanitizes AI-generated content for safe display.
**Dependencies:** [`dompurify`](dompurify).
**Last Updated:** 2025-08-21

#### sanitizeMessagesForModel(messages: UIMessage[]): UIMessage[]
**Purpose:** Sanitizes message array for AI model consumption.
**Dependencies:** None.
**Last Updated:** 2025-08-21

### Mention Processing
**Location:** `apps/web/src/lib/ai/`

#### processMentionsInMessage(content: string): ProcessedMentions
**Purpose:** Processes @mentions in AI messages for context injection.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### buildMentionSystemPrompt(mentions: Mention[]): string
**Purpose:** Builds system prompt from page/user mentions.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### createMentionToolInstructions(pageIds: string[], mentions: Mention[]): string
**Purpose:** Creates tool instructions for mentioned entities.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### hasMentions(content: string): boolean
**Purpose:** Checks if content contains @mentions.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### extractPageIds(content: string): string[]
**Purpose:** Extracts page IDs from mention strings.
**Dependencies:** None.
**Last Updated:** 2025-08-21

### Role Management
**Location:** `apps/web/src/lib/ai/`

#### createRoleContext(role: string, pageContext?: any, userContext?: any): string
**Purpose:** Creates role-based context for AI agent behavior.
**Dependencies:** None.
**Last Updated:** 2025-08-21

### Permission Validation
**Location:** `apps/web/src/lib/ai/`

#### validateToolPermissions(accessLevel: string, requiredLevel: string): boolean
**Purpose:** Validates if user has required permissions for AI tool usage.
**Dependencies:** None.
**Last Updated:** 2025-08-21

### AI Tools - Enhanced Search & Discovery
**Location:** `apps/web/src/lib/ai/tools/search-tools.ts`

#### regex_search
**Purpose:** Search page content using regular expression patterns with support for multiple match types and contexts. Returns pages with pageId, title, semantic paths, and content snippets for operations and discovery.
**Parameters:** pattern (string), driveId (optional), pageTypes (optional), caseSensitive (optional), maxResults (optional)
**Returns:** Array of matches with pageId, title, path, matchCount, and content snippets
**Dependencies:** [`db`](packages/db), [`getUserAccessLevel`](packages/lib/permissions), [`getUserDriveAccess`](packages/lib/permissions).
**Last Updated:** 2025-01-21

#### glob_search
**Purpose:** Find pages using glob-style patterns for titles and paths (e.g., "**/README*", "meeting-*.md", "**/2024/**"). Supports hierarchical pattern matching for structural discovery.
**Parameters:** pattern (string), driveId (optional), pageTypes (optional), maxResults (optional)
**Returns:** Array of matches with pageId, title, path, type, and parentPath
**Dependencies:** [`db`](packages/db), [`getUserAccessLevel`](packages/lib/permissions), [`getUserDriveAccess`](packages/lib/permissions).
**Last Updated:** 2025-01-21

#### multi_drive_search
**Purpose:** Search for content across multiple drives simultaneously with automatic permission filtering and cross-workspace capability. Returns results grouped by drive for easy navigation.
**Parameters:** query (string), searchType (content/title/both), pageTypes (optional), maxResultsPerDrive (optional), includeSnippets (optional)
**Returns:** Object with results grouped by drive, total matches, and search statistics
**Dependencies:** [`db`](packages/db), [`getUserDriveAccess`](packages/lib/permissions), [`getUserAccessLevel`](packages/lib/permissions).
**Last Updated:** 2025-01-21

### AI Tools - Task Management System
**Location:** `apps/web/src/lib/ai/tools/task-management-tools.ts`

#### create_task_list
**Purpose:** Create persistent task lists for complex multi-step operations that span across AI conversations.
**Dependencies:** [`db`](packages/db), [`broadcastTaskEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-07

#### get_task_list
**Purpose:** Get current status of task lists including all tasks and their progress with completion tracking.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-09-07

#### update_task_status
**Purpose:** Update task status (pending/in_progress/completed/blocked) with automatic list completion detection.
**Dependencies:** [`db`](packages/db), [`broadcastTaskEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-07

#### add_task
**Purpose:** Add new tasks to existing task lists with priority and position management.
**Dependencies:** [`db`](packages/db), [`broadcastTaskEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-07

#### add_task_note
**Purpose:** Add progress notes and updates to specific tasks for documentation and context.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-09-07

#### resume_task_list
**Purpose:** Resume task lists from previous conversations, enabling cross-session task continuity.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-09-07

### AI Tools - Batch Operations
**Location:** `apps/web/src/lib/ai/tools/batch-operations-tools.ts`

#### bulk_delete_pages
**Purpose:** Delete multiple pages in one atomic operation with optional child deletion support.
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`canUserDeletePage`](packages/lib/permissions), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-19

#### bulk_update_content
**Purpose:** Update content in multiple pages using replace, append, or prepend operations in one atomic transaction.
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-19

#### bulk_move_pages
**Purpose:** Move multiple pages to new parent location in one atomic operation while maintaining relative order.
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`getUserDriveAccess`](packages/lib/permissions), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-07

#### bulk_rename_pages
**Purpose:** Rename multiple pages using patterns (find/replace, prefix, suffix, template) in single operation.
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-07

#### create_folder_structure
**Purpose:** Create complex nested folder structures with multiple levels in one atomic operation.
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`getUserDriveAccess`](packages/lib/permissions), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-09-07

### AI Tools - Agent Management & Communication
**Location:** `apps/web/src/lib/ai/tools/`

#### list_agents
**Purpose:** List all AI agents in a specific drive with their configuration details and conversation history status.
**Parameters:** driveId (string), driveSlug (optional), includeSystemPrompt (optional), includeTools (optional)
**Returns:** Object with agent list, count, and drive information
**Dependencies:** [`db`](packages/db), [`canUserViewPage`](packages/lib/permissions).
**Last Updated:** 2025-01-21

#### multi_drive_list_agents
**Purpose:** List all AI agents across ALL accessible drives for comprehensive agent discovery.
**Parameters:** includeSystemPrompt (optional), includeTools (optional), groupByDrive (optional)
**Returns:** Object with agents grouped by drive or flat list with total counts
**Dependencies:** [`db`](packages/db), [`getUserDriveAccess`](packages/lib/permissions).
**Last Updated:** 2025-01-21

#### ask_agent
**Purpose:** Consult another AI agent for specialized knowledge or assistance with sophisticated cross-agent communication. Supports depth control to prevent infinite recursion and preserves conversation context.
**Parameters:** agentPath (string), agentId (string), question (string), context (optional)
**Returns:** Object with agent response, metadata, processing time, and tool execution details
**Dependencies:** [`db`](packages/db), [`canUserViewPage`](packages/lib/permissions), [`getConfiguredModel`](agent-communication-tools), [`generateText`](ai).
**Key Features:**
- **Depth Control**: Maximum 3-level agent consultation to prevent infinite loops
- **Context Preservation**: Target agent's full conversation history included
- **Permission Inheritance**: Uses requesting user's permissions
- **Tool Execution**: Target agent can use its configured tools
- **Ephemeral Consultation**: Results not saved to target agent's conversation
**Last Updated:** 2025-01-21

#### create_agent
**Purpose:** Create fully configured AI agents with custom system prompts and tool permissions in one operation. Specialized tool for creating AI_CHAT pages with complete agent configuration.
**Parameters:** driveId (string), title (string), parentId (optional), systemPrompt (string), enabledTools (array), aiProvider (optional), aiModel (optional), description (optional)
**Returns:** Object with created agent details and configuration status
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`pageSpaceTools`](apps/web/lib/ai/ai-tools), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-01-21

#### update_agent_config
**Purpose:** Update existing AI agent configuration including system prompt, enabled tools, AI provider, and model settings.
**Parameters:** pageId (string), systemPrompt (optional), enabledTools (optional), aiProvider (optional), aiModel (optional)
**Returns:** Object with updated configuration details
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`pageSpaceTools`](apps/web/lib/ai/ai-tools), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Last Updated:** 2025-01-21

### AI Tools - Enhanced Page Creation
**Location:** `apps/web/src/lib/ai/tools/page-write-tools.ts`

#### create_page (Enhanced)
**Purpose:** Create new pages with support for all page types including AI_CHAT pages with optional agent configuration. Enhanced version now supports setting systemPrompt, enabledTools, aiProvider, and aiModel for AI agents in one operation.
**Dependencies:** [`db`](packages/db), [`canUserEditPage`](packages/lib/permissions), [`pageSpaceTools`](apps/web/lib/ai/ai-tools), [`broadcastPageEvent`](apps/web/lib/socket-utils).
**Key Features:**
- **Agent Configuration Support**: Can create fully configured AI agents with system prompt and tools
- **Tool Validation**: Validates enabled tools against available PageSpace tools
- **Provider Override**: Allows setting custom AI provider and model for specific agents
- **Backward Compatibility**: Maintains existing behavior for non-agent page creation
**Last Updated:** 2025-09-10

### AI Monitoring & Analytics
**Location:** `apps/web/src/lib/ai/monitoring.ts`

#### calculateCost(provider: string, model: string, inputTokens: number, outputTokens: number): number
**Purpose:** Calculates cost for AI API usage based on token consumption.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### estimateTokens(text: string): number
**Purpose:** Estimates token count for text input using approximation.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### trackAIUsage(data: AIUsageData): Promise<void>
**Purpose:** Tracks AI usage metrics for analytics and billing.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackAIToolUsage(data: AIToolUsage): Promise<void>
**Purpose:** Tracks AI tool usage for feature analytics.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### getUserAIStats(userId: string, timeRange: string): Promise<AIStats>
**Purpose:** Retrieves user AI usage statistics for given time range.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### getPopularAIFeatures(timeRange: string): Promise<AIFeatureStats[]>
**Purpose:** Gets most popular AI features based on usage data.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### detectAIErrorPatterns(timeRange: string): Promise<AIErrorPattern[]>
**Purpose:** Analyzes AI error patterns for debugging and optimization.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### getTokenEfficiencyMetrics(timeRange: string): Promise<TokenEfficiencyMetrics>
**Purpose:** Calculates token efficiency metrics across AI interactions.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

## Utility Functions

### Permission Management
**Location:** `packages/lib/src/permissions.ts`

#### getUserAccessLevel(userId: string, pageId: string): Promise<AccessLevel>
**Purpose:** Determines user's access level for specific page considering drive membership and explicit permissions.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### canUserViewPage(userId: string, pageId: string): Promise<boolean>
**Purpose:** Checks if user has view permissions for page.
**Dependencies:** [`getUserAccessLevel`](packages/lib/permissions:getUserAccessLevel()).
**Last Updated:** 2025-08-21

#### canUserEditPage(userId: string, pageId: string): Promise<boolean>
**Purpose:** Checks if user has edit permissions for page.
**Dependencies:** [`getUserAccessLevel`](packages/lib/permissions:getUserAccessLevel()).
**Last Updated:** 2025-08-21

#### canUserSharePage(userId: string, pageId: string): Promise<boolean>
**Purpose:** Checks if user has share permissions for page.
**Dependencies:** [`getUserAccessLevel`](packages/lib/permissions:getUserAccessLevel()).
**Last Updated:** 2025-08-21

#### canUserDeletePage(userId: string, pageId: string): Promise<boolean>
**Purpose:** Checks if user has delete permissions for page.
**Dependencies:** [`getUserAccessLevel`](packages/lib/permissions:getUserAccessLevel()).
**Last Updated:** 2025-08-21

#### isUserDriveMember(userId: string, driveId: string): Promise<boolean>
**Purpose:** Checks if user is member of specific drive.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### getUserAccessiblePagesInDrive(userId: string, driveId: string): Promise<Page[]>
**Purpose:** Returns all pages in drive that user can access.
**Dependencies:** [`db`](packages/db), [`getUserAccessLevel`](packages/lib/permissions:getUserAccessLevel()).
**Last Updated:** 2025-08-21

#### grantPagePermissions(pageId: string, userId: string, permissions: Permission[]): Promise<void>
**Purpose:** Grants specific permissions to user for page.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### revokePagePermissions(pageId: string, userId: string): Promise<void>
**Purpose:** Revokes all permissions from user for page.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### getUserDriveAccess(userId: string, driveId: string): Promise<DriveAccessLevel>
**Purpose:** Gets user's access level for specific drive.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

### Tree Utilities
**Location:** `packages/lib/src/tree-utils.ts`

#### buildTree<T>(nodes: T[]): TreeNode<T>[]
**Purpose:** Builds hierarchical tree structure from flat array of nodes with parent-child relationships.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### findNodeAndParent<T>(tree: TreeNode<T>[], nodeId: string): {node: TreeNode<T>, parent: TreeNode<T> | null}
**Purpose:** Finds node and its parent in tree structure.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### removeNode<T>(tree: TreeNode<T>[], nodeId: string): TreeNode<T>[]
**Purpose:** Removes node from tree structure.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### addNode<T>(tree: TreeNode<T>[], node: TreeNode<T>, parentId?: string): TreeNode<T>[]
**Purpose:** Adds node to tree structure at specified parent.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### mergeChildren<T>(tree: TreeNode<T>[], nodeId: string, children: TreeNode<T>[]): TreeNode<T>[]
**Purpose:** Merges children into existing tree node.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### buildPagePath(tree: TreeNode<Page>[], pageId: string): Page[]
**Purpose:** Builds breadcrumb path from root to specific page.
**Dependencies:** None.
**Last Updated:** 2025-08-21

### Content Processing
**Location:** `packages/lib/src/content-utils.ts`

#### getPageContentForAI(page: Page): string
**Purpose:** Extracts and formats page content for AI processing, handling different page types.
**Dependencies:** [`cheerio`](cheerio).
**Last Updated:** 2025-08-21

#### slugify(text: string): string
**Purpose:** Converts text to URL-friendly slug format.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### toTitleCase(str: string): string
**Purpose:** Converts string to title case format.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### cn(...inputs: ClassValue[]): string
**Purpose:** Utility for conditional class name composition with clsx and tailwind-merge.
**Dependencies:** [`clsx`](clsx), [`tailwind-merge`](tailwind-merge).
**Last Updated:** 2025-08-21

### Activity Tracking
**Location:** `packages/lib/src/tracking-utils.ts`

#### trackActivity(userId: string, activity: string, metadata?: any): Promise<void>
**Purpose:** Records user activity for analytics and audit logging.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackPageOperation(userId: string, operation: string, pageId: string, metadata?: any): Promise<void>
**Purpose:** Tracks page-specific operations (create, edit, delete, share).
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackDriveOperation(userId: string, operation: string, driveId: string, metadata?: any): Promise<void>
**Purpose:** Tracks drive-specific operations (create, member add/remove, settings change).
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackAiUsage(userId: string, provider: string, model: string, tokens: number, cost: number): Promise<void>
**Purpose:** Tracks AI usage for billing and analytics.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackFeature(userId: string, feature: string, metadata?: any): Promise<void>
**Purpose:** Tracks feature usage for product analytics.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackAuthEvent(userId: string, event: string, metadata?: any): Promise<void>
**Purpose:** Tracks authentication-related events for security monitoring.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackSearch(userId: string, query: string, resultCount: number, searchType: string): Promise<void>
**Purpose:** Tracks search operations for improving search functionality.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackNavigation(userId: string, fromPath: string, toPath: string): Promise<void>
**Purpose:** Tracks navigation patterns for UX optimization.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackError(userId: string, errorMessage: string, errorType: string, context?: any): Promise<void>
**Purpose:** Tracks errors for debugging and stability monitoring.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### trackApiCall(userId: string, endpoint: string, method: string, statusCode: number): Promise<void>
**Purpose:** Tracks API call patterns for performance monitoring.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

### Notification Management
**Location:** `packages/lib/src/notification-utils.ts`

#### createNotification(params: NotificationParams): Promise<Notification>
**Purpose:** Creates new notification with specified type and recipients.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### getUserNotifications(userId: string, limit?: number): Promise<Notification[]>
**Purpose:** Retrieves paginated notifications for user.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### getUnreadNotificationCount(userId: string): Promise<number>
**Purpose:** Gets count of unread notifications for user.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### markNotificationAsRead(notificationId: string, userId: string): Promise<void>
**Purpose:** Marks specific notification as read.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### markAllNotificationsAsRead(userId: string): Promise<void>
**Purpose:** Marks all user notifications as read.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### deleteNotification(notificationId: string, userId: string): Promise<void>
**Purpose:** Deletes notification for user.
**Dependencies:** [`db`](packages/db).
**Last Updated:** 2025-08-21

#### createPermissionNotification(params: PermissionNotificationParams): Promise<void>
**Purpose:** Creates notification for permission changes.
**Dependencies:** [`createNotification`](packages/lib/notification-utils:createNotification()).
**Last Updated:** 2025-08-21

#### createDriveNotification(params: DriveNotificationParams): Promise<void>
**Purpose:** Creates notification for drive-related events.
**Dependencies:** [`createNotification`](packages/lib/notification-utils:createNotification()).
**Last Updated:** 2025-08-21

### Logging & Monitoring
**Location:** `packages/lib/src/monitoring-utils.ts`

#### extractRequestContext(req: Request): RequestContext
**Purpose:** Extracts context information from HTTP request for logging.
**Dependencies:** None.
**Last Updated:** 2025-08-21

#### logRequest(context: RequestContext, request: any): void
**Purpose:** Logs incoming HTTP request with context.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### logResponse(context: RequestContext, response: any): void
**Purpose:** Logs outgoing HTTP response with timing.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### logAIRequest(context: RequestContext, data: any): void
**Purpose:** Logs AI API requests for monitoring and debugging.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### logDatabaseQuery(context: RequestContext, query: any): void
**Purpose:** Logs database queries with execution time.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### logAuthEvent(context: RequestContext, event: any): void
**Purpose:** Logs authentication events for security monitoring.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### logSecurityEvent(context: RequestContext, event: any): void
**Purpose:** Logs security-related events for audit trail.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### logPerformance(context: RequestContext, metric: any): void
**Purpose:** Logs performance metrics for optimization.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### createRequestLogger(requestId: string): Logger
**Purpose:** Creates request-scoped logger with correlation ID.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### withLogging<T>(fn: Function, context: any): Promise<T>
**Purpose:** Wraps function with automatic logging of entry/exit and errors.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### setupErrorHandlers(): void
**Purpose:** Sets up global error handlers for uncaught exceptions.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

#### initializeLogging(): void
**Purpose:** Initializes logging system with configured transports.
**Dependencies:** [`winston`](winston).
**Last Updated:** 2025-08-21

---

## Summary

The PageSpace codebase contains **over 350 documented functions** across 9 major categories:

1. **Database Functions** (8 functions): Core database operations, migrations, and admin utilities
2. **Authentication & Security** (15 functions): JWT, CSRF, encryption, and rate limiting
3. **API Route Handlers** (85+ functions): Complete REST API covering all application features
4. **AI & LLM Functions** (50+ functions): Advanced tool calling, agent communication, search tools, task management, batch operations, capability detection, and monitoring
5. **Utility Functions** (60+ functions): Permissions, content processing, tracking, and notifications
6. **Component Functions** (70+ functions): React components for complete UI
7. **Custom React Hooks** (40+ functions): State management and side effects
8. **Store Functions** (10 functions): Zustand stores for global state
9. **Real-time Functions** (15 functions): Socket.IO for live collaboration

### **Enhanced AI Tool System Added (January 2025):**

#### **Enhanced Search & Discovery Tools** (3 functions)
- **regex_search**: Pattern-based content search with snippets and permission filtering
- **glob_search**: Structural discovery using glob patterns with hierarchical matching
- **multi_drive_search**: Cross-workspace search with drive grouping and statistics

#### **Task Management System** (6 functions)
- **create_task_list**: Persistent task tracking across AI conversations
- **get_task_list**: Progress monitoring with completion tracking
- **update_task_status**: Status management with automatic progression
- **add_task**: Dynamic task list expansion with dependencies
- **add_task_note**: Progress documentation and context preservation
- **resume_task_list**: Cross-session task continuity with filters

#### **Batch Operations** (5 functions)
- **bulk_delete_pages**: Delete multiple pages with optional child deletion
- **bulk_update_content**: Update content in multiple pages atomically
- **bulk_move_pages**: Mass page relocation with order preservation
- **bulk_rename_pages**: Pattern-based bulk renaming (find/replace, prefix, suffix, template)
- **create_folder_structure**: Complex nested hierarchy creation

#### **Agent Management & Communication** (5 functions)
- **list_agents**: Discover AI agents within specific drives
- **multi_drive_list_agents**: Global agent discovery across all accessible drives
- **ask_agent**: Sophisticated agent-to-agent communication with depth control
- **create_agent**: Create fully configured AI agents with system prompt and tool permissions
- **update_agent_config**: Update existing agent configuration including tools and behavior

#### **Model Capability Detection System** (New)
- **hasVisionCapability**: Automatic vision support detection for 100+ models
- **hasToolCapability**: Tool support validation with OpenRouter API integration
- **getModelCapabilities**: Comprehensive capability detection with caching
- **getSuggestedToolCapableModels**: Intelligent fallback suggestions

Each function includes proper TypeScript typing, comprehensive error handling, and follows established architectural patterns. The codebase demonstrates a well-structured monorepo with clear separation of concerns between database operations, business logic, API endpoints, and UI components.

**Key Architectural Patterns:**
- **Next.js 15 App Router** with async params handling
- **Drizzle ORM** for type-safe database operations
- **RBAC permissions system** with granular access control
- **Real-time collaboration** via Socket.IO
- **Local-first AI integration** with multiple provider support
- **Enhanced AI tooling** with persistent task management and batch operations
- **Advanced search capabilities** with regex and glob pattern support
- **Comprehensive monitoring** and analytics tracking
- **Secure authentication** with JWT and CSRF protection

## File Processing Functions

### Processor Service Functions
**Location:** `apps/processor/src/`

#### ContentStore Functions
**Location:** `apps/processor/src/cache/content-store.ts`

##### storeFile(buffer: Buffer, fileName: string): Promise<StoreResult>
**Purpose:** Stores a file using content-addressed storage with SHA256 hashing for deduplication.
**Dependencies:** [`crypto`](crypto), [`fs/promises`](fs/promises), [`path`](path).
**Returns:** StoreResult with contentHash, size, mimeType, and isNew flag.
**Last Updated:** 2025-09-13

##### getFile(contentHash: string): Promise<Buffer | null>
**Purpose:** Retrieves a file by its content hash from the storage system.
**Dependencies:** [`fs/promises`](fs/promises).
**Last Updated:** 2025-09-13

##### hasFile(contentHash: string): Promise<boolean>
**Purpose:** Checks if a file exists in storage by its content hash.
**Dependencies:** [`fs/promises`](fs/promises).
**Last Updated:** 2025-09-13

##### getMetadata(contentHash: string): Promise<FileMetadata | null>
**Purpose:** Retrieves metadata for a stored file including original name, size, and upload information.
**Dependencies:** [`fs/promises`](fs/promises).
**Last Updated:** 2025-09-13

#### Image Processing Functions
**Location:** `apps/processor/src/workers/image-processor.ts`

##### processImage(contentHash: string, preset: string): Promise<ProcessResult>
**Purpose:** Processes images according to preset configurations (ai-chat, ai-vision, thumbnail, preview).
**Dependencies:** [`sharp`](sharp), [`content-store`](cache/content-store).
**Presets:** ai-chat (1920px), ai-vision (2048px), thumbnail (200px), preview (800px).
**Last Updated:** 2025-09-13

##### optimizeForAI(buffer: Buffer, maxSize?: number, quality?: number): Promise<OptimizedImage>
**Purpose:** Optimizes images specifically for AI model consumption with size and quality controls.
**Dependencies:** [`sharp`](sharp).
**Last Updated:** 2025-09-13

#### Queue Manager Functions
**Location:** `apps/processor/src/workers/queue-manager.ts`

##### addImageJob(contentHash: string, preset: string): Promise<void>
**Purpose:** Adds an image processing job to the queue for background processing.
**Dependencies:** [`queue`](internal), [`image-processor`](workers/image-processor).
**Last Updated:** 2025-09-13

##### addTextExtractionJob(contentHash: string, mimeType: string): Promise<void>
**Purpose:** Queues text extraction job for documents (PDF, DOCX, etc.).
**Dependencies:** [`queue`](internal), [`text-extractor`](workers/text-extractor).
**Status:**  Partially implemented.
**Last Updated:** 2025-09-13

##### processJobs(): Promise<void>
**Purpose:** Processes queued jobs with concurrency limits and retry logic.
**Dependencies:** [`queue`](internal), [`workers`](workers/*).
**Last Updated:** 2025-09-13

#### Text Extraction Functions
**Location:** `apps/processor/src/workers/text-extractor.ts`

##### extractFromPDF(buffer: Buffer): Promise<string>
**Purpose:** Extracts text content from PDF files.
**Dependencies:** [`pdf-parse`](pdf-parse) (planned).
**Status:**  Not implemented.
**Last Updated:** 2025-09-13

##### extractFromDOCX(buffer: Buffer): Promise<string>
**Purpose:** Extracts text content from DOCX files.
**Dependencies:** [`mammoth`](mammoth) (planned).
**Status:**  Not implemented.
**Last Updated:** 2025-09-13

##### extractFromText(buffer: Buffer): Promise<string>
**Purpose:** Extracts text from plain text files (TXT, MD).
**Dependencies:** Node.js Buffer.
**Status:**  Implemented.
**Last Updated:** 2025-09-13

### File Upload API Functions
**Location:** `apps/web/src/app/api/upload/route.ts`

#### POST /api/upload Handler
**Purpose:** Handles file uploads with authentication, validation, processor forwarding, and database entry creation.
**Dependencies:** [`processor-service`](http://processor:3003), [`db`](packages/db), [`auth`](lib/auth-utils).
**Key Features:**
- **Authentication check** with JWT validation
- **File size validation** (100MB limit)
- **Filename sanitization** for Unicode spaces
- **Processor service integration** for storage
- **Status assignment** (visual for images, pending for documents)
**Last Updated:** 2025-09-13

### File Viewing Functions
**Location:** `apps/web/src/app/api/files/[id]/view/route.ts`

#### GET /api/files/[id]/view Handler
**Purpose:** Serves files to authenticated users with permission checks and processor service integration.
**Dependencies:** [`processor-service`](http://processor:3003), [`permissions`](lib/permissions), [`db`](packages/db).
**Key Features:**
- **Permission validation** for file access
- **Content streaming** from processor service
- **Proper headers** for content type and disposition
**Last Updated:** 2025-09-13

### AI Visual Content Functions
**Location:** `apps/web/src/lib/ai/visual-content-utils.ts`

#### loadVisualContent(page: Page, provider: string): Promise<VisualContent>
**Purpose:** Loads visual content for AI vision models with provider-specific optimization.
**Dependencies:** [`processor-service`](http://processor:3003), [`ai-providers`](lib/ai/ai-providers-config).
**Key Features:**
- **Provider-specific formatting** (base64 or URL)
- **Size limit enforcement** (10MB max)
- **Caching strategy** for performance
**Last Updated:** 2025-09-13

## Component Functions

### AI Agent Configuration Components
**Location:** `apps/web/src/components/ai/`

#### AgentSettingsTab (React.forwardRef<AgentSettingsTabRef, AgentSettingsTabProps>)
**Purpose:** AI agent configuration form component using react-hook-form with Controller pattern for optimal checkbox performance. Handles system prompt, AI provider/model selection, and tool permissions management.
**Dependencies:** [`react-hook-form`](react-hook-form), [`ui-components`](components/ui), [`ai-providers`](lib/ai/ai-providers-config).
**Key Features:** 
- **useImperativeHandle** for external form submission from parent components
- **Controller pattern** prevents checkbox lag through single source of truth
- **Provider/model selection** with configuration status validation
- **Tool permission management** with select/deselect all functionality
- **Validation** against available PageSpace tools
**Last Updated:** 2025-09-10

#### AgentSettingsTabRef (Interface)
**Purpose:** TypeScript interface defining imperative methods exposed by AgentSettingsTab component for parent component interaction.
**Methods:**
- `submitForm(): void` - Triggers form submission externally
- `isSaving: boolean` - Readonly saving state for UI feedback
**Last Updated:** 2025-09-10

### AI Chat View Components
**Location:** `apps/web/src/components/layout/middle-content/page-views/ai-page/`

#### AiChatView (React.FC<AiChatViewProps>)
**Purpose:** Main AI chat interface with tabbed layout (Chat/Settings) and conditional header controls. Features save button relocation to header area with tab-specific visibility.
**Dependencies:** [`ai-sdk-react`](ai-sdk/react), [`AgentSettingsTab`](components/ai/AgentSettingsTab), [`ui-components`](components/ui).
**Key Features:**
- **Header refactor** with conditional save button display
- **Tab-specific overflow** handling (chat: hidden for sticky input, settings: auto for scrolling)
- **Provider configuration** validation and API key management
- **Real-time streaming** with Vercel AI SDK integration
- **Permission-aware** with read-only mode support
**Last Updated:** 2025-09-10

### Canvas Dashboard Components
**Location:** `apps/web/src/components/canvas/` and `apps/web/src/components/layout/middle-content/page-views/canvas/`

#### ShadowCanvas (React.FC<ShadowCanvasProps>)
**Purpose:** Renders user HTML/CSS in an isolated Shadow DOM with functional navigation. Extracts styles from HTML, sanitizes content for security, and intercepts clicks for PageSpace navigation.
**Props:** `html: string`, `onNavigate?: (url: string, isExternal: boolean) => void`
**Dependencies:** [`DOMPurify`](dompurify), [`sanitizeCSS`](lib/canvas/css-sanitizer)
**Key Features:**
- **Shadow DOM isolation** for complete style encapsulation
- **Theme independence** - looks identical in light/dark mode
- **Navigation interception** for links and buttons with data-href
- **CSS extraction** from embedded `<style>` tags
- **Security sanitization** of HTML and CSS content
**Last Updated:** 2025-01-16

#### CanvasPageView (React.FC<CanvasPageViewProps>)
**Purpose:** Main canvas page component with Code/View tabs. Provides Monaco editor for HTML editing and ShadowCanvas for rendering with navigation handling and permission checking.
**Props:** `page: TreePage`
**Dependencies:** [`ShadowCanvas`](components/canvas/ShadowCanvas), [`MonacoEditor`](components/editors/MonacoEditor), [`getUserAccessLevel`](lib)
**Key Features:**
- **Dual-view interface** with Code and View tabs
- **Monaco Editor** for HTML/CSS editing
- **Permission checking** before navigation
- **Auto-save** functionality
**Last Updated:** 2025-01-16

### Canvas Utility Functions
**Location:** `apps/web/src/lib/canvas/`

#### sanitizeCSS (function)
**Purpose:** Light-touch CSS sanitization for canvas pages. Removes JavaScript execution vectors while preserving creative CSS features.
**Parameters:** `css: string`
**Returns:** `string` - Sanitized CSS
**Security:** Blocks expression(), -moz-binding, javascript: URLs, @import
**Last Updated:** 2025-01-16

#### extractStylesFromHTML (function)
**Purpose:** Extracts `<style>` tags from HTML content and returns separated HTML and CSS.
**Parameters:** `htmlContent: string`
**Returns:** `{ html: string, css: string }`
**Last Updated:** 2025-01-16

This documentation serves as a complete reference for all functions available in the PageSpace application, enabling developers to quickly understand and extend the codebase. The recent additions significantly enhance the AI assistant's capability to handle complex, multi-step operations while maintaining data consistency and user permissions.