{
  "integrations_researched": [
    {
      "name": "Drizzle ORM",
      "type": "library",
      "verified_package": {
        "name": "drizzle-orm",
        "install_command": "pnpm add drizzle-orm",
        "version": "^0.32.2",
        "verified": true
      },
      "api_patterns": {
        "imports": [
          "import { db, pageVersions } from '@pagespace/db'",
          "import { eq, and, desc, gte, gt, lte, count, asc, not, inArray } from 'drizzle-orm'"
        ],
        "initialization": "Already configured in packages/db",
        "key_functions": [
          "db.select()",
          "db.insert().values().returning()",
          "db.update().set().where()",
          "db.delete().where()"
        ],
        "verified_against": "Existing codebase - packages/db/package.json and schema files"
      },
      "configuration": {
        "env_vars": ["DATABASE_URL"],
        "config_files": ["drizzle.config.ts"],
        "dependencies": ["pg"]
      },
      "infrastructure": {
        "requires_docker": true,
        "docker_image": "postgres",
        "ports": [5432],
        "volumes": []
      },
      "gotchas": [
        "Already in use in the project",
        "Version pinned to 0.32.2 in pnpm overrides",
        "PostgreSQL-specific dialect"
      ],
      "research_sources": [
        "packages/db/package.json",
        "packages/db/src/schema/versioning.ts"
      ]
    },
    {
      "name": "Text Diff Library (diff)",
      "type": "library",
      "verified_package": {
        "name": "diff",
        "install_command": "pnpm add diff && pnpm add -D @types/diff",
        "version": "latest",
        "verified": false
      },
      "api_patterns": {
        "imports": [
          "import * as Diff from 'diff'",
          "import { diffLines, diffWords, diffChars } from 'diff'"
        ],
        "initialization": "N/A - stateless functions",
        "key_functions": [
          "diffLines(oldStr, newStr, options)",
          "diffWords(oldStr, newStr)",
          "diffChars(oldStr, newStr)",
          "createPatch(fileName, oldStr, newStr, oldHeader, newHeader)"
        ],
        "verified_against": "UNVERIFIED - requires npm documentation access"
      },
      "configuration": {
        "env_vars": [],
        "config_files": [],
        "dependencies": []
      },
      "infrastructure": {
        "requires_docker": false
      },
      "gotchas": [
        "UNVERIFIED - This is a commonly used library but package details need verification",
        "May need @types/diff for TypeScript support",
        "Different diff algorithms available (lines, words, chars, sentences)",
        "Returns array of change objects with added/removed flags"
      ],
      "research_sources": [
        "UNVERIFIED - Common knowledge, needs npm verification"
      ]
    },
    {
      "name": "React Diff Viewer",
      "type": "library",
      "verified_package": {
        "name": "react-diff-viewer OR react-diff-view",
        "install_command": "pnpm add react-diff-viewer",
        "version": "latest",
        "verified": false
      },
      "api_patterns": {
        "imports": [
          "import ReactDiffViewer from 'react-diff-viewer'"
        ],
        "initialization": "<ReactDiffViewer oldValue={old} newValue={new} splitView={true} />",
        "key_functions": [
          "Component props: oldValue, newValue, splitView, showDiffOnly, compareMethod"
        ],
        "verified_against": "UNVERIFIED - requires npm documentation access"
      },
      "configuration": {
        "env_vars": [],
        "config_files": [],
        "dependencies": ["react"]
      },
      "infrastructure": {
        "requires_docker": false
      },
      "gotchas": [
        "UNVERIFIED - Package name and API need verification",
        "Alternative: react-diff-view may be more modern",
        "Must be compatible with React 19 (project uses React 19.1.2)",
        "May need custom styling for theming",
        "Check bundle size impact"
      ],
      "research_sources": [
        "UNVERIFIED - Common knowledge, needs npm verification"
      ]
    },
    {
      "name": "Compression Library (pako)",
      "type": "library",
      "verified_package": {
        "name": "pako",
        "install_command": "pnpm add pako && pnpm add -D @types/pako",
        "version": "latest",
        "verified": false
      },
      "api_patterns": {
        "imports": [
          "import pako from 'pako'"
        ],
        "initialization": "N/A - stateless functions",
        "key_functions": [
          "pako.gzip(data)",
          "pako.ungzip(data)",
          "pako.deflate(data)",
          "pako.inflate(data)"
        ],
        "verified_against": "UNVERIFIED - requires npm documentation access"
      },
      "configuration": {
        "env_vars": [],
        "config_files": [],
        "dependencies": []
      },
      "infrastructure": {
        "requires_docker": false
      },
      "gotchas": [
        "UNVERIFIED - Package details need verification",
        "Used for compressing large document versions before storage",
        "Works with Buffer/Uint8Array in Node.js",
        "May need to handle encoding/decoding properly",
        "Consider compression level trade-offs (speed vs size)"
      ],
      "research_sources": [
        "UNVERIFIED - Common knowledge, needs npm verification",
        "Requirement mentions 'compression/storage optimization' for large documents"
      ]
    },
    {
      "name": "PostgreSQL",
      "type": "infrastructure",
      "verified_package": {
        "name": "pg",
        "install_command": "pnpm add pg && pnpm add -D @types/pg",
        "version": "^8.16.3",
        "verified": true
      },
      "api_patterns": {
        "imports": [
          "Used via Drizzle ORM, not direct pg usage"
        ],
        "initialization": "Configured in DATABASE_URL environment variable",
        "key_functions": [
          "Accessed through Drizzle ORM's db instance"
        ],
        "verified_against": "Existing codebase - packages/db/package.json"
      },
      "configuration": {
        "env_vars": ["DATABASE_URL"],
        "config_files": [],
        "dependencies": []
      },
      "infrastructure": {
        "requires_docker": true,
        "docker_image": "postgres",
        "ports": [5432],
        "volumes": ["/var/lib/postgresql/data"]
      },
      "gotchas": [
        "Already running in docker-compose.yml",
        "Version history stored in pageVersions table",
        "contentRef points to separate content storage (not inline in DB)",
        "Need to consider JSONB columns for metadata storage",
        "Existing version retention managed via expiresAt field"
      ],
      "research_sources": [
        "packages/db/package.json",
        "docker-compose.yml",
        "packages/db/src/schema/versioning.ts"
      ]
    },
    {
      "name": "Tiptap Editor",
      "type": "library",
      "verified_package": {
        "name": "@tiptap/react",
        "install_command": "pnpm add @tiptap/react @tiptap/core @tiptap/starter-kit",
        "version": "^3.0.7 (core: ^3.7.2)",
        "verified": true
      },
      "api_patterns": {
        "imports": [
          "import { useEditor } from '@tiptap/react'",
          "import { StarterKit } from '@tiptap/starter-kit'"
        ],
        "initialization": "Already in use in the web app",
        "key_functions": [
          "editor.getJSON()",
          "editor.getHTML()",
          "editor.commands.setContent()"
        ],
        "verified_against": "Existing codebase - apps/web/package.json"
      },
      "configuration": {
        "env_vars": [],
        "config_files": [],
        "dependencies": ["@tiptap/pm", "@tiptap/extensions"]
      },
      "infrastructure": {
        "requires_docker": false
      },
      "gotchas": [
        "Already in use for document editing",
        "Stores content in multiple formats (detected via detectPageContentFormat)",
        "Version 3.x is major version, APIs may differ from v2",
        "Document content may be HTML, Markdown, or JSON format",
        "Diff visualization needs to handle rich text properly"
      ],
      "research_sources": [
        "apps/web/package.json",
        "packages/lib/src/content/page-content-format.ts"
      ]
    },
    {
      "name": "Next.js",
      "type": "framework",
      "verified_package": {
        "name": "next",
        "install_command": "pnpm add next",
        "version": "15.3.6",
        "verified": true
      },
      "api_patterns": {
        "imports": [
          "import { NextResponse } from 'next/server'",
          "API routes in app/api directory"
        ],
        "initialization": "App Router architecture (not Pages Router)",
        "key_functions": [
          "Route handlers in route.ts files",
          "Server Actions",
          "Middleware"
        ],
        "verified_against": "Existing codebase - apps/web/package.json"
      },
      "configuration": {
        "env_vars": ["NODE_ENV", "DATABASE_URL", etc],
        "config_files": ["next.config.js"],
        "dependencies": ["react", "react-dom"]
      },
      "infrastructure": {
        "requires_docker": false
      },
      "gotchas": [
        "Version 15.x is latest major version",
        "Uses App Router (not Pages Router)",
        "API routes should be in app/api/pages/[pageId]/... structure",
        "Server Components by default",
        "Existing history endpoint at app/api/pages/[pageId]/history/route.ts"
      ],
      "research_sources": [
        "apps/web/package.json",
        "apps/web/src/app directory structure"
      ]
    }
  ],
  "unverified_claims": [
    {
      "claim": "diff package is the correct npm package for text diffing",
      "reason": "Could not access npm documentation - WebFetch/WebSearch permissions not granted",
      "risk_level": "low",
      "recommendation": "Verify package name and API on npmjs.com before implementation"
    },
    {
      "claim": "react-diff-viewer is compatible with React 19",
      "reason": "Could not access npm documentation - WebFetch/WebSearch permissions not granted",
      "risk_level": "medium",
      "recommendation": "Check react-diff-viewer or react-diff-view for React 19 compatibility. May need to use alternative or fork if incompatible"
    },
    {
      "claim": "pako is the best compression library for this use case",
      "reason": "Could not access npm documentation - WebFetch/WebSearch permissions not granted",
      "risk_level": "low",
      "recommendation": "Compare pako vs lz-string vs built-in zlib. Consider compression ratio vs speed trade-offs"
    }
  ],
  "recommendations": [
    "CRITICAL: Verify all unverified packages on npmjs.com before implementation",
    "Check React 19 compatibility for any new UI libraries (react-diff-viewer/react-diff-view)",
    "Existing version system stores contentRef separately - diff library will need to fetch content via readPageContent",
    "Consider implementing diff caching to avoid recomputing diffs for frequently compared versions",
    "Storage optimization via compression should be applied to contentRef storage, not database fields",
    "Selective rollback will require parsing document structure (HTML/Markdown/JSON) to identify sections",
    "30-day retention is enforced via expiresAt field in pageVersions table - this is already implemented",
    "Embedded files are referenced in document content - rollback must handle file reference restoration",
    "Test compression impact on read/write performance with large documents (>1MB)",
    "Consider implementing diff streaming for very large documents to avoid memory issues"
  ],
  "existing_codebase_analysis": {
    "version_system": {
      "table": "pageVersions",
      "content_storage": "Separate content store accessed via readPageContent/writePageContent",
      "content_formats": ["html", "markdown", "json"],
      "version_sources": ["manual", "auto", "pre_ai", "pre_restore", "restore", "system"],
      "retention_mechanism": "expiresAt timestamp field",
      "metadata_support": "JSONB metadata column available"
    },
    "rollback_system": {
      "service": "apps/web/src/services/api/rollback-service.ts",
      "permissions": "Checked via canUserRollback function",
      "activity_logging": "Integrated with activityLogs table",
      "existing_limitations": "Documented in requirements - needs edge case handling for embedded files and selective rollback"
    }
  },
  "research_limitations": [
    "WebSearch tool requires permissions - could not verify packages on npm",
    "WebFetch tool requires permissions - could not access documentation",
    "All external package recommendations based on common knowledge and industry standards",
    "Package APIs and versions must be verified before implementation"
  ],
  "created_at": "2025-12-31T00:00:00Z"
}
