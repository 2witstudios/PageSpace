# Dynamic pnpm package path resolution
# Handles version changes without manual Podfile updates
def resolve_pnpm_package(package_name)
  base = '../../../../node_modules/.pnpm'
  # Replace / with + for pnpm directory naming (e.g., @capacitor/ios -> @capacitor+ios)
  dir_pattern = package_name.gsub('/', '+')
  pattern = "#{base}/#{dir_pattern}@*/node_modules/#{package_name}"
  matches = Dir.glob(pattern)
  raise "Package not found: #{package_name}. Run 'pnpm install' first." if matches.empty?
  # Use semantic version comparison (not lexicographic) for correct ordering
  matches.max_by do |path|
    version_match = path.match(%r{#{Regexp.escape(dir_pattern)}@([^_/]+)})
    version_str = version_match ? version_match[1] : '0.0.0'
    Gem::Version.new(version_str)
  end
end

require_relative resolve_pnpm_package('@capacitor/ios') + '/scripts/pods_helpers'

platform :ios, '14.0'
use_frameworks!

# workaround to avoid Xcode caching of Pods that requires
# Product -> Clean Build Folder after new Cordova plugins installed
# Requires CocoaPods 1.6 or newer
install! 'cocoapods', :disable_input_output_paths => true

def capacitor_pods
  pod 'Capacitor', :path => '../../../../node_modules/.pnpm/@capacitor+ios@7.4.5_@capacitor+core@7.4.5/node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../../../node_modules/.pnpm/@capacitor+ios@7.4.5_@capacitor+core@7.4.5/node_modules/@capacitor/ios'
  pod 'AparajitaCapacitorSecureStorage', :path => '../../../../node_modules/.pnpm/@aparajita+capacitor-secure-storage@7.1.6/node_modules/@aparajita/capacitor-secure-storage'
  pod 'CapgoCapacitorSocialLogin', :path => '../../../../node_modules/.pnpm/@capgo+capacitor-social-login@7.20.0_@capacitor+core@7.4.5/node_modules/@capgo/capacitor-social-login'
  pod 'CapacitorApp', :path => '../../../../node_modules/.pnpm/@capacitor+app@7.1.1_@capacitor+core@7.4.5/node_modules/@capacitor/app'
  pod 'CapacitorBrowser', :path => '../../../../node_modules/.pnpm/@capacitor+browser@7.0.3_@capacitor+core@7.4.5/node_modules/@capacitor/browser'
  pod 'CapacitorKeyboard', :path => '../../../../node_modules/.pnpm/@capacitor+keyboard@7.0.4_@capacitor+core@7.4.5/node_modules/@capacitor/keyboard'
  pod 'CapacitorPreferences', :path => '../../../../node_modules/.pnpm/@capacitor+preferences@7.0.3_@capacitor+core@7.4.5/node_modules/@capacitor/preferences'
  pod 'CapacitorSplashScreen', :path => '../../../../node_modules/.pnpm/@capacitor+splash-screen@7.0.4_@capacitor+core@7.4.5/node_modules/@capacitor/splash-screen'
  pod 'CapacitorStatusBar', :path => '../../../../node_modules/.pnpm/@capacitor+status-bar@7.0.4_@capacitor+core@7.4.5/node_modules/@capacitor/status-bar'
end

target 'App' do
  capacitor_pods
  # Add your Pods here
end

post_install do |installer|
  assertDeploymentTarget(installer)
end
